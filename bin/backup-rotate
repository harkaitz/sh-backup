#!/bin/sh -e
##:
#h: Usage: backup-rotate [-m MAX] NAME-REGEX [HOSTNAME-REGEX]
#h:
#h: Delete backups named as with with `backup-name` if they exceed MAX
#h: copies (by default 5).
##:
. backup-list
backup_rotate() {
    local OPTIND optopt max=
    ## Parse command line options.
    while getopts "m:" optopt; do
        case $optopt in
            m)  max=$(( ${OPTARG} + 1));;
            \?) return 1;;
        esac
    done
    shift $(( $OPTIND - 1 ))
    ## List backups to delete.
    backup_list "$@" | tail -n +"${max:-5}" | xargs rm -vf
}
## -------------------------------------------------------------------
if test @"$(basename "$0")" = @"backup-rotate";then
    case "${1}" in
        ''|-h|--help) sed -n 's/^ *#h: \{0,1\}//p' "$0" ;;
        *)            backup_rotate "$@"; exit 0;;
    esac
fi
